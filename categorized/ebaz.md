# EBAZ4205 Notes

[Getting Started with the Zynq](../resource/Getting%20Started%20with%20the%20Zynq.pdf) contains info on setting up the project in Vivado, Vitis, and the boot selection pins on the PCB.

## Boot selection

(From the PDF)

```
Fixed JTAG: R present in R2584 (pull-down) and not present in R2577 (pull-up). R present in
R2585 (pull-down) and not present in R2578 (pull-up).
Fixed NAND: R present in R2584 (pull-down) and not present in R2577 (pull-up). R not present in
R2585 (pull-down) and present in R2578 (pull-up).
Fixed uSD: R not present in R2584 (pull-down) and present in R2577 (pull-up). R not present in
R2585 (pull-down) and present in R2578 (pull-up).
Fixed QSPI: R not present in R2584 (pull-down) and present in R2577 (pull-up). R present in
R2585 (pull-down) and not present in R2578 (pull-up).
```

The board arrives with the resistors configured to boot off NAND. To change it to boot off uSD, I removed the resistor R2584, but I did not add the resistor R2577. I tried adding a wire, but it was finnicky as I was unable to solder it. Currently, the board has neither resistor. It boots off the SD, but it is pretty unreliable.

## SD boot

Image to boot off SD: https://renjikai.com/ebaz4205-sd-ubuntu18/
Repo with the Vivado project to go with it: https://github.com/bjrjk/EBAZ4205

Tcl script for the above block design, capable of being dropped into any project (just source the script in vivado): https://gist.github.com/panther03/3abc61886fb75446306cf6a3463d91a6

*Note that you can change the bitstream once booted off the above image (with JTAG or using Linux fpga_manager; see below), but you must use a design that includes the Ethernet connection in the PL, otherwise you will break the network connection to the board after loading bitstream!*

## Loading Bitstream + Zynq FW

For SD boot, BOOT.BIN is loaded off SD. Contains Zynq initialization code + bitstream. Needs to be generated by Vitis (note: new version is fucky and bad.) 

*Since EBAZ has no external clock, need this set up properly to have a clock on the system! Cannot have a design without initializing Zynq in FW.*

JTAG: use vivado HW manager.

Load from linux: Copy file to board using SD or scp. Following Vivado TCL command generates the proper bitstream, as a byte swapped format is required. Normally, bootgen will take care of this when you do a full Zynq project, but if you want to have the bitstream file standalone, you need this.

```
write_cfgmem -force -format bin -interface smapx32 -disablebitswap -loadbit "up 0 {{name}}.bit" {{name}}.bin
```

Use the following sysfs commands to flash bitstream, on Linux system running on board

```bash
echo 0 > /sys/class/fpga_manager/fpga0/flags
# assume test.bin is bitstream file copied to ebaz
# firmware directory doesnt exist on fresh firmware
cp test.bin /lib/firmware 
# this looks for the name test.bin in /lib/firmware
# if there are problems, check dmesg
echo test.bin > /sys/class/fpga_manager/fpga0/firmware
```